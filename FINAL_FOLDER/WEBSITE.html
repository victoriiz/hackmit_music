<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Beat Rush</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#111; color:#eee; margin:0; padding:12px; }
    .controls { display:flex; gap:12px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    input, button { padding:8px; border-radius:6px; border: none; }
    button { background:#2b7; color:#032; cursor:pointer; }
    button:disabled { background:#555; cursor:not-allowed; }
    label { font-size:14px; }
    .hud { margin-top:8px; }
    canvas { display:block; margin:8px auto; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.6); }
    #loadingMsg { color: #7af; font-weight: bold; }
  </style>
</head>
<body>
  <h2 style="text-align:center">Beat Rush</h2>

  <div class="controls">
    <button id="connectBtn">Connect micro:bit (USB)</button>

    <label>
      Audio:
      <input type="file" id="audioUpload" accept="audio/*">
    </label>

    <button id="startBtn" disabled>Start Playback & Game</button>
  </div>

  <div class="hud" style="text-align:center">
    Detected tempo: <strong id="tempoDisplay">â€”</strong> BPM |
    Score: <strong id="scoreDisplay">0</strong>
  </div>
  <div style="text-align:center" id="loadingMsg"></div>

<script>
// ---------- CONFIG ----------
const CANVAS_W = 780, CANVAS_H = 420;
const HIT_LINE_Y = 350;
const START_Y = -40;
const NOTE_TRAVEL_TIME = 1.8;
const HIT_WINDOW = 0.20;

// ---------- STATE ----------
let scheduledBeats = [];
let beatIndex = 0;
let activeNotes = [];
let score = 0;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let audioBuffer = null;
let bufferSource = null;
let audioStarted = false;
let audioStartTime = 0;
let tempoFromJSON = null;

let port = null, reader = null;

// ---------- NOTE IMAGES ----------
let whiteNotes = [], purpleNotes = [];

function preload() {
  whiteNotes.push(loadImage('note_pngs/Note_white1.png'));
  whiteNotes.push(loadImage('note_pngs/Note_white2.png'));
  whiteNotes.push(loadImage('note_pngs/Note_white3.png'));
  purpleNotes.push(loadImage('note_pngs/Note_purple1.png'));
  purpleNotes.push(loadImage('note_pngs/Note_purple2.png'));
  purpleNotes.push(loadImage('note_pngs/Note_purple3.png'));
}

// ---------- p5.js ----------
function setup(){
  createCanvas(CANVAS_W, CANVAS_H);
  textSize(18);
}

function draw(){
  background(18);

  if (audioStarted && scheduledBeats.length > 0){
    const now = audioCtx.currentTime - audioStartTime;
    while (beatIndex < scheduledBeats.length && now >= (scheduledBeats[beatIndex].time - NOTE_TRAVEL_TIME)){
      const beat = scheduledBeats[beatIndex];
      const x = beat.type === "left" ? random(130, 270) : random(510, 650);
      const spawnTime = beat.time - NOTE_TRAVEL_TIME;
      const speed = (HIT_LINE_Y - START_Y) / NOTE_TRAVEL_TIME;
      const img = beat.type === "left" ? random(whiteNotes) : random(purpleNotes);

      activeNotes.push({ x, y: START_Y, type: beat.type, beatTime: beat.time, spawnTime, speed, img });
      beatIndex++;
    }
  }

  for (let i = activeNotes.length - 1; i >= 0; i--){
    const n = activeNotes[i];
    n.y += n.speed * (deltaTime / 1000);
    imageMode(CENTER);
    image(n.img, n.x, n.y, 36, 36);

    if (n.y > height + 80) activeNotes.splice(i, 1);
  }

  stroke(255, 60, 60);
  strokeWeight(3);
  line(0, HIT_LINE_Y, width, HIT_LINE_Y);

  noStroke();
  fill(230);
  textAlign(LEFT, TOP);
  text("Score: " + score, 12, 12);
  document.getElementById("scoreDisplay").innerText = score;
}

// ---------- Serial (micro:bit) ----------
document.getElementById("connectBtn").addEventListener("click", async () => {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    const decoder = new TextDecoderStream();
    port.readable.pipeTo(decoder.writable);
    reader = decoder.readable.getReader();
    readLoop();
    alert("Connected to micro:bit (USB). Press A/B to play.");
  } catch (err) {
    console.error("Serial error:", err);
    alert("Serial connect failed: " + (err?.message || err));
  }
});

async function readLoop(){
  try {
    while (true){
      const { value, done } = await reader.read();
      if (done) break;
      if (!value) continue;
      handleInput(value.trim());
    }
  } catch (err) { console.error("Serial readLoop error", err); }
}

function handleInput(input){
  if (!audioStarted) return;
  const now = audioCtx.currentTime - audioStartTime;
  let bestIndex = -1, bestDt = Infinity;
  for (let i = 0; i < activeNotes.length; i++){
    const n = activeNotes[i];
    if ((input === "A" && n.type === "left") || (input === "B" && n.type === "right")){
      const dt = Math.abs(n.beatTime - now);
      if (dt < bestDt){ bestDt = dt; bestIndex = i; }
    }
  }
  if (bestIndex !== -1 && bestDt <= HIT_WINDOW){
    score += Math.round((HIT_WINDOW - bestDt) / HIT_WINDOW * 100) + 50;
    activeNotes.splice(bestIndex, 1);
    document.getElementById("scoreDisplay").innerText = score;
  }
}

// ---------- Audio file upload ----------
const audioInput = document.getElementById("audioUpload");
const startBtn = document.getElementById("startBtn");
const loadingMsg = document.getElementById("loadingMsg");

audioInput.addEventListener("change", async (e) => {
  const f = e.target.files[0];
  if (!f) return;

  const arrayBuffer = await f.arrayBuffer();
  audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

  startBtn.disabled = true;
  loadingMsg.textContent = "Waiting for beats JSON...";

  const jsonPath = `beats/${f.name.replace(/\.[^/.]+$/, "")}_beats.json`;

  const waitForJSON = async () => {
    for (let i = 0; i < 20; i++) {
      try {
        const res = await fetch(jsonPath);
        if (res.ok){
          const data = await res.json();
          scheduledBeats = data.notes.slice().sort((a,b) => a.time - b.time);
          tempoFromJSON = data.tempo;
          document.getElementById("tempoDisplay").innerText = Math.round(tempoFromJSON);
          loadingMsg.textContent = "";
          startBtn.disabled = false;
          return;
        }
      } catch {}
      await new Promise(r => setTimeout(r, 500));
    }
    loadingMsg.textContent = "Failed to load beats JSON.";
    alert("Failed to load beats JSON. Make sure the Python watcher processed the file.");
  };

  await waitForJSON();
});

// ---------- Start game ----------
startBtn.addEventListener("click", async () => {
  if (!audioBuffer) { alert("Please upload an audio file first."); return; }
  if (!scheduledBeats || scheduledBeats.length === 0) { alert("Beats not loaded yet."); return; }

  await audioCtx.resume();
  if (bufferSource) { try { bufferSource.stop(); } catch(e){} bufferSource.disconnect(); }

  bufferSource = audioCtx.createBufferSource();
  bufferSource.buffer = audioBuffer;
  bufferSource.connect(audioCtx.destination);

  audioStartTime = audioCtx.currentTime + 0.05;
  bufferSource.start(audioStartTime);
  audioStarted = true;
  beatIndex = 0;
  activeNotes = [];
  score = 0;
  document.getElementById("scoreDisplay").innerText = score;
});

// ---------- Debug hotkeys ----------
window.addEventListener('keydown', (e) => {
  if (e.key === '1') handleInput('A');
  if (e.key === '2') handleInput('B');
  if (e.key === 'r'){
    if (bufferSource) try { bufferSource.stop(); } catch(e) {}
    audioStarted = false;
    beatIndex = 0;
    activeNotes = [];
    score = 0;
    document.getElementById("scoreDisplay").innerText = 0;
  }
});
</script>
</body>
</html>
