<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Micro:bit Rhythm Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
</head>
<body>
<h2>Micro:bit Rhythm Game</h2>
<button id="connectBtn">Connect Micro:bit via USB</button>
<input type="file" id="audioUpload" accept="audio/*">
<label>BPM: <input type="number" id="bpmInput" value="120"></label>
<p>Score: <span id="scoreDisplay">0</span></p>

<script>
let port, reader;
let notes = [];
let score = 0;

// Web Audio
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let source = null;

// Beat sync
let bpm = 120;
let secondsPerBeat = 0.5;
let nextBeatTime = 0;
let noteTravelTime = 2; // seconds for note to fall from top to hit line

// p5.js setup
function setup() {
  createCanvas(600, 400);
  textSize(20);
}

function draw() {
  background(30);

  if (source) {
    const currentTime = audioCtx.currentTime - source.startTime;

    // Spawn note if it's time for next beat
    if (currentTime >= nextBeatTime) {
      nextBeatTime += secondsPerBeat;

      // Random left/right note
      const type = Math.random() < 0.5 ? "left" : "right";
      const x = type === "left" ? random(100, 250) : random(350, 500);
      // Calculate starting y so it reaches hit line at exact beat
      const y = 0;
      const speed = (height - 50) / noteTravelTime;
      notes.push({x, y, type, speed});
    }
  }

  // Draw and move notes
  for (let i = notes.length-1; i >= 0; i--) {
    notes[i].y += notes[i].speed * (deltaTime / 1000);

    fill(notes[i].type === "left" ? "blue" : "green");
    ellipse(notes[i].x, notes[i].y, 30, 30);

    if (notes[i].y > height) {
      notes.splice(i,1); // remove missed note
    }
  }

  // Hit line
  stroke(255,0,0);
  line(0,height-50,width,height-50);

  fill(255);
  text("Score: " + score, 20, 30);
  document.getElementById("scoreDisplay").innerText = score;
}

// --- Micro:bit USB connection ---
document.getElementById("connectBtn").onclick = async () => {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    const decoder = new TextDecoderStream();
    port.readable.pipeTo(decoder.writable);
    reader = decoder.readable.getReader();
    readLoop();
  } catch (err) {
    console.error("Serial error:", err);
  }
};

async function readLoop() {
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    if (value) handleInput(value.trim());
  }
}

function handleInput(input) {
  for (let i = notes.length-1; i >=0; i--) {
    if (input === "A" && notes[i].type === "left" && abs(notes[i].y - (height-50)) < 30) {
      score += 100;
      notes.splice(i,1);
      break;
    }
    if (input === "B" && notes[i].type === "right" && abs(notes[i].y - (height-50)) < 30) {
      score += 100;
      notes.splice(i,1);
      break;
    }
  }
}

// --- File upload ---
const fileInput = document.getElementById("audioUpload");
fileInput.addEventListener("change", async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const arrayBuffer = await file.arrayBuffer();
  const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

  if (source) source.disconnect();
  source = audioCtx.createBufferSource();
  source.buffer = audioBuffer;
  source.connect(audioCtx.destination);
  source.start();
  source.startTime = audioCtx.currentTime;

  // Initialize beat timing
  bpm = parseFloat(document.getElementById("bpmInput").value);
  secondsPerBeat = 60 / bpm;
  nextBeatTime = 0;
  notes = [];
});
</script>
</body>
</html>
